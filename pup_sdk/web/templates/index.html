<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel='stylesheet' href='/static/style.css'>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/htmx.min.js"></script>
    <style>
        .typing-indicator::after {
            content: '.';
            animation: typing 1.5s steps(3, end) infinite;
        }
        @keyframes typing {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        .message-appear {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .paw-bg {
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.05'%3E%3Cpath d='M20 20c0-5.5-4.5-10-10-10s-10 4.5-10 10 4.5 10 10 10 10-4.5 10-10zm10 0c0-5.5-4.5-10-10-10s-10 4.5-10 10 4.5 10 10 10 10-4.5 10-10z'/%3E%3C/g%3E%3C/svg%3E");
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 min-h-screen paw-bg">
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-6">
            <div class="inline-flex items-center gap-2 mb-4">
                <span class="text-4xl">üêï</span>
                <h1 class="text-3xl font-bold text-gray-800">Alberto</h1>
                <span class="text-4xl">üêï</span>
            </div>
            <p class="text-gray-600">Your sassy code puppy - here to help you code! üêæ</p>
            <div class="mt-2 flex justify-center gap-4">
                <span
                    id="status-badge"
                    class="px-3 py-1 rounded-full text-sm font-medium {% if connected %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}"
                    data-connected="{{ 'true' if connected else 'false' }}"
                    data-demo="{{ 'true' if demo_mode else 'false' }}"
                >
                    {% if connected %}üîµ Connected{% elif demo_mode %}üü° Demo Mode{% else %}üü° Demo Mode{% endif %}
                </span>
                <button onclick="toggleDarkMode()" class="p-2 rounded hover:bg-gray-200">
                    <span id="theme-icon">üåô</span>
                </button>
            </div>
        </header>

        <!-- Chat Messages Container -->
        <div id="chat-container" class="bg-white rounded-lg shadow-lg p-4 mb-4 h-96 overflow-y-auto">
            <div id="messages" class="space-y-3">
                <!-- Welcome Message -->
                <div class="flex gap-3 message-appear">
                    <div class="text-2xl flex-shrink-0">üêï</div>
                    <div class="flex-1">
                        <div class="bg-purple-100 rounded-lg p-3 max-w-[90%]">
                            <p class="text-gray-800 text-sm" id="welcome-text">
                                üêï Woof! Hey there! I'm Alberto, your favorite code puppy! ü¶Æ
                                <span id="welcome-state">
                                {% if connected %}
                                I'm online and ready to help you with coding, file operations, shell commands, and more!
                                {% else %}
                                I'm currently running in demo mode, but I can still chat! Connect to the real Alberto for full functionality.
                                {% endif %}
                                </span>
                                What can I help you with today?
                            </p>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">Alberto ‚Ä¢ Just now</div>
                    </div>
                </div>
            </div>
            <div id="typing-indicator" class="hidden">
                <div class="flex gap-3">
                    <div class="text-2xl flex-shrink-0">üêï</div>
                    <div class="bg-gray-100 rounded-lg p-3 typing-indicator">
                        Thinking
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Form -->
        <form id="chat-form" class="mb-4">
            <div class="flex gap-2">
                <input 
                    type="text" 
                    id="message-input" 
                    placeholder="What do you want to chat about?" 
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    autocomplete="off"
                    required
                >
                <button 
                    type="submit" 
                    id="send-button"
                    class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                >
                    Send üëå
                </button>
            </div>
        </form>

        <!-- Quick Actions -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
            <button onclick="sendQuickMessage('What can you do?')" class="px-3 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">
                ü§î What can you do?
            </button>
            <button onclick="sendQuickMessage('Help me read a file')" class="px-3 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">
                üìÑ Read a file
            </button>
            <button onclick="sendQuickMessage('Run a shell command')" class="px-3 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">
                üíª Run command
            </button>
            <button onclick="sendQuickMessage('Tell me a joke')" class="px-3 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">
                üòÑ Tell me a joke
            </button>
        </div>

        <!-- Info Section -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h3 class="font-semibold text-blue-900 mb-2">üì± Mobile Friendly Tips:</h3>
            <ul class="text-sm text-blue-800 space-y-1">
                <li>‚Ä¢ Works great on phones and tablets!</li>
                <li>‚Ä¢ Ready for HuggingFace Spaces deployment</li>
                <li>‚Ä¢ Connect to real Alberto for full functionality</li>
                <li>‚Ä¢ Supports file operations, code editing, and more!</li>
            </ul>
        </div>
    </div>

    <script>
        let isDarkMode = false;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('chat-form');
            const input = document.getElementById('message-input');
            
            form.addEventListener('submit', handleSubmit);
            input.focus();

            refreshStatus();
            setInterval(refreshStatus, 15000);
        });
        
        async function refreshStatus() {
            const badge = document.getElementById('status-badge');
            if (!badge) return;
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                updateStatusUI(data);
            } catch (error) {
                console.warn('Status refresh failed:', error);
                updateStatusUI(null);
            }
        }

        function updateStatusUI(status) {
            const badge = document.getElementById('status-badge');
            if (!badge) return;

            const connected = Boolean(status && status.available && status.connected && !status.demo_mode);
            const demoMode = Boolean(status && status.demo_mode);

            badge.classList.remove(
                'bg-green-100','text-green-800',
                'bg-yellow-100','text-yellow-800',
                'bg-red-100','text-red-800'
            );

            if (connected) {
                badge.classList.add('bg-green-100','text-green-800');
                badge.textContent = 'üîµ Connected';
            } else if (demoMode) {
                badge.classList.add('bg-yellow-100','text-yellow-800');
                badge.textContent = 'üü° Demo Mode';
            } else {
                badge.classList.add('bg-red-100','text-red-800');
                badge.textContent = 'üî¥ Offline';
            }

            badge.dataset.connected = connected;
            badge.dataset.demo = demoMode;

            const welcomeState = document.getElementById('welcome-state');
            if (welcomeState) {
                if (connected) {
                    welcomeState.textContent = " I'm online and ready to help you with coding, file operations, shell commands, and more! ";
                } else if (demoMode) {
                    welcomeState.textContent = " I'm currently running in demo mode, but I can still chat! Connect to the real Alberto for full functionality. ";
                } else {
                    welcomeState.textContent = " I can't reach my backend right now, but demo mode is still available. Give me a moment and try again! ";
                }
            }
        }
        
        async function handleSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            await sendMessage(message);
            input.value = '';
            input.focus();
        }
        
        async function sendMessage(message) {
            // Add user message
            addMessage(message, 'user');
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        include_reasoning: false,
                        auto_execute: false
                    })
                });
                
                const data = await response.json();
                hideTypingIndicator();
                
                if (data.success) {
                    addMessage(data.response, 'alberto', data.reasoning);
                } else {
                    addMessage(`Oops! Something went wrong: ${data.message || 'Unknown error'}`, 'alberto');
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage(`Connection error: ${error.message}. Is Alberto available?`, 'alberto');
            }
        }
        
        function sendQuickMessage(message) {
            document.getElementById('message-input').value = message;
            document.getElementById('chat-form').dispatchEvent(new Event('submit'));
        }
        
        function addMessage(content, sender, reasoning = null) {
            const messagesContainer = document.getElementById('messages');
            const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const messageHtml = `
                <div class="flex gap-3 message-appear ${sender === 'user' ? 'justify-end' : ''}">
                    ${sender === 'alberto' ? '<div class="text-2xl flex-shrink-0">üêï</div>' : ''}
                    <div class="flex-1 ${sender === 'user' ? 'text-right' : ''}">
                        <div class="${sender === 'user' ? 'bg-indigo-100 ml-auto' : 'bg-purple-100'} rounded-lg p-3 max-w-[90%] inline-block">
                            <p class="text-gray-800 text-sm">${escapeHtml(content)}</p>
                            ${reasoning ? `<div class="mt-2 pt-2 border-t border-purple-200 text-xs text-gray-600 italic">${escapeHtml(reasoning)}</div>` : ''}
                        </div>
                        <div class="text-xs text-gray-500 mt-1">${sender === 'user' ? 'You' : 'Alberto'} ‚Ä¢ ${timestamp}</div>
                    </div>
                    ${sender === 'user' ? '<div class="text-2xl flex-shrink-0">üë§</div>' : ''}
                </div>
            `;
            
            messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
            scrollToBottom();
        }
        
        function showTypingIndicator() {
            document.getElementById('typing-indicator').classList.remove('hidden');
            scrollToBottom();
        }
        
        function hideTypingIndicator() {
            document.getElementById('typing-indicator').classList.add('hidden');
        }
        
        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            const icon = document.getElementById('theme-icon');
            const body = document.body;
            
            if (isDarkMode) {
                body.classList.add('dark');
                body.classList.remove('bg-gradient-to-br', 'from-purple-50', 'to-indigo-100');
                body.classList.add('bg-gray-900');
                icon.textContent = '‚òÄÔ∏è';
            } else {
                body.classList.remove('dark', 'bg-gray-900');
                body.classList.add('bg-gradient-to-br', 'from-purple-50', 'to-indigo-100');
                icon.textContent = 'üåô';
            }
        }
        </script>
</body>
</html>