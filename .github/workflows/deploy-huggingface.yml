name: Deploy Pup SDK to HuggingFace Spaces

on:
  workflow_dispatch:
  push:
    branches: ['main']

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      
      - name: Set up Git identity
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Hugging Face CLI
        run: pip install 'huggingface_hub[cli]'
      
      - name: Generate or update hf-space app files
        run: |
          mkdir -p hf-space
          cd hf-space
          echo 'fastapi' > requirements.txt
          echo 'uvicorn[standard]' >> requirements.txt
          cat << 'EOF' > app.py
from fastapi import FastAPI
app = FastAPI()

@app.get("/")
def greet_json():
    return {"Hello": "World!"}
EOF
          cat << 'EOF' > Dockerfile
FROM python:3.9
RUN useradd -m -u 1000 user
USER user
ENV PATH="/home/user/.local/bin:$PATH"
WORKDIR /app
COPY --chown=user ./requirements.txt requirements.txt
RUN pip install --no-cache-dir --upgrade -r requirements.txt
COPY --chown=user . /app
CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "7860"]
EOF
      
      - name: Commit hf-space changes back to GitHub (optional)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add hf-space
          git commit -m "üê∂ Pup SDK auto-deploy - update hf-space" || echo "no changes to commit"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/AlbertoRoca-web/pup-sdk.git"
          git push origin HEAD:main
      
      - name: Deploy to Hugging Face Space via CLI
        env:
          HF_TOKEN: ${{ secrets.HUGGINGPUP }}
        run: |
          cd hf-space
          huggingface-cli upload --repo-type space --repo-id AlbertoRoca96-web/pup-sdk --commit-message "üê∂ Pup SDK auto-deploy from GitHub Actions" .