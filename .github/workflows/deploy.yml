name: Deploy to HuggingFace

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (full clone)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install huggingface_hub

      - name: Clone HuggingFace Space with full history
        env:
          HF_TOKEN: ${{ secrets.HUGGINGPUP }}
        run: |
          echo "ğŸ”— Cloning HuggingFace Space with full history..."
          rm -rf hf-space
          git clone https://AlbertoRoca96-web:${HF_TOKEN}@huggingface.co/spaces/AlbertoRoca96-web/pup-sdk hf-space
          cd hf-space
          echo "ğŸ“ Space repo contents:"
          ls -la
          cd ..

      - name: Generate and sync Pup SDK app files
        run: |
          echo "ğŸ“ Generating Pup SDK app files..."

          # requirements.txt for Pup SDK Space (include aiohttp)
          cat > requirements.txt << 'EOF'
          fastapi
          uvicorn[standard]
          jinja2
          python-multipart
          aiohttp
          EOF

          # app.py that launches real Alberto
          cat > app.py << 'EOF'
          import os
          from pup_sdk.web import launch_web

          if __name__ == "__main__":
              port = int(os.environ.get("PORT", 7860))
              host = os.environ.get("HOST", "0.0.0.0")
              launch_web(host=host, port=port)
          EOF

          # Dockerfile for Space (no editable install, no stray \n)
          cat > Dockerfile << 'EOF'
          FROM python:3.9

          RUN useradd -m -u 1000 user
          USER user
          ENV PATH="/home/user/.local/bin:$PATH"

          WORKDIR /app

          # Copy requirements first for better caching
          COPY requirements.txt .
          RUN pip install --no-cache-dir --upgrade pip && \
              pip install --no-cache-dir -r requirements.txt

          # Copy the entire app (including pup_sdk)
          COPY . .

          CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "7860"]
          EOF

          # Copy static assets if they exist
          if [ -d "assets" ]; then
            cp -r assets/* hf-space/ 2>/dev/null || true
          fi

          # Sync files to hf-space
          echo "ğŸ’¾ Syncing files to Space repository..."
          cp -v requirements.txt app.py Dockerfile hf-space/

          # Copy pup_sdk package to hf-space (so import pup_sdk.web works)
          if [ -d "pup_sdk" ]; then
            cp -rv pup_sdk/ hf-space/
          fi

          echo "ğŸ“‹ Updated hf-space contents:"
          ls -la hf-space/

      - name: Commit and push to HuggingFace Space
        env:
          HF_TOKEN: ${{ secrets.HUGGINGPUP }}
        run: |
          cd hf-space

          # Configure git for the Space repository
          git config user.name "Alberto Code Puppy"
          git config user.email "alberto@code-puppy.ai"

          # Add all changes
          echo "ğŸ“ Adding changes to git..."
          git add -A

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            echo "ğŸ’¾ Committing changes..."
            git commit -m "Sync Pup SDK app files from GitHub main"

            echo "ğŸš€ Pushing to HuggingFace Space..."
            git push
          fi

          echo "âœ… Space deployment complete!"
