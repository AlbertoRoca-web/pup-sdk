name: Deploy to HuggingFace

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install huggingface_hub

      - name: Generate hf-space files (Real Alberto UI)
        run: |
          mkdir -p hf-space

          # requirements.txt for Alberto UI
          cat > hf-space/requirements.txt << 'EOF'
          pup-sdk
          fastapi
          uvicorn[standard]
          jinja2
          python-multipart
          EOF

          # app.py that launches real Alberto
          cat > hf-space/app.py << 'EOF'
          import os
          from pup_sdk.web import launch_web

          if __name__ == "__main__":
              port = int(os.environ.get("PORT", 7860))
              host = os.environ.get("HOST", "0.0.0.0")
              launch_web(host=host, port=port)
          EOF

          # Dockerfile for Alberto UI
          cat > hf-space/Dockerfile << 'EOF'
          FROM python:3.9

          RUN useradd -m -u 1000 user
          USER user
          ENV PATH="/home/user/.local/bin:$PATH"

          WORKDIR /app

          # Copy the entire pup-sdk package
          COPY . .

          # Install requirements including the package itself
          RUN pip install --no-cache-dir --upgrade pip && \
              pip install --no-cache-dir -e . && \
              pip install fastapi uvicorn[standard] jinja2 python-multipart

          EXPOSE 7860
          CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "7860"]
          EOF

      - name: Upload Alberto UI to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HUGGINGPUP }}
          HUGGINGFACE_HUB_TOKEN: ${{ secrets.HUGGINGPUP }}
        run: |
          python - << 'PY'
          import os
          from huggingface_hub import HfApi

          token = os.environ.get("HF_TOKEN") or os.environ.get("HUGGINGFACE_HUB_TOKEN")
          assert token, "HF_TOKEN/HUGGINGFACE_HUB_TOKEN is not set in env"

          api = HfApi(token=token)

          # Debug: confirm which HF user this token belongs to
          print("WHOAMI:", api.whoami())

          repo_id = "AlbertoRoca96-web/pup-sdk"
          local_dir = "hf-space"

          commit_info = api.upload_folder(
              repo_id=repo_id,
              repo_type="space",
              folder_path=local_dir,
              commit_message="ðŸ¶ Deploy REAL Alberto Code Puppy UI from GitHub Actions",
              create_pr=True,  # create PR instead of committing directly to main
          )
          print("ðŸŽ‰ Alberto UI upload result:", commit_info)
          print("ðŸ”— PR URL will be available on the HuggingFace Space page!")
          PY