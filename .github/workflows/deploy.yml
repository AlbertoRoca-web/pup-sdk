name: Deploy to HuggingFace

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (full clone)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install rsync
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync

      - name: Clone HuggingFace Space
        env:
          HF_TOKEN: ${{ secrets.HUGGINGPUP }}
        run: |
          echo "üîó Cloning HuggingFace Space..."
          rm -rf hf-space
          git clone "https://AlbertoRoca96-web:${HF_TOKEN}@huggingface.co/spaces/AlbertoRoca96-web/pup-sdk" hf-space
          cd hf-space
          echo "üìÅ Space repo contents (before sync):"
          ls -la

      - name: Sync project files into Space repo
        run: |
          set -e
          echo "üíæ Syncing files into hf-space..."

          # Backend
          cp -v app.py requirements.txt Dockerfile hf-space/

          # Pup SDK package
          rsync -av --delete pup_sdk/ hf-space/pup_sdk/

          # Frontend build files expected by Dockerfile
          cp -v package*.json vite.config.js tailwind.config.js hf-space/
          rsync -av --delete frontend/ hf-space/frontend/

          echo "üìã Updated hf-space contents:"
          ls -R hf-space/

      - name: Commit and push to HuggingFace Space
        env:
          HF_TOKEN: ${{ secrets.HUGGINGPUP }}
        run: |
          cd hf-space

          git config user.name  "Alberto Code Puppy"
          git config user.email "alberto@code-puppy.ai"

          git add -A

          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
          else
            echo "üíæ Committing and pushing..."
            git commit -m "Sync from GitHub main"
            git push
          fi

          echo "‚úÖ Space deployment complete!"
